<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<script src="https://unpkg.com/leaflet@latest/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
<script src="https://unpkg.com/@turf/turf@latest"></script>
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<style>
.control-box {
  height: 3em;
  width: 15em;
  background-color: #eeeeee;
}

.zone-label {
  white-space: nowrap;
  color: blue;
  font-size: 1.5em;
}
</style>
</head>
<body>
<div id="map" style="height: 100vh;"></div>

<script>
  // Set some defaults
  let startPoint = [55.5, -3]
  let zoom = 6

  // Initialize the map
  var mymap = L.map('map').setView(startPoint, zoom);
  let control = new L.control.layers({}, {})

  // Add the leaflet-geoman plugin
  mymap.pm.addControls({
    position: 'topleft',
    drawMarker: false,
    drawCircleMarker: false,
    drawRectangle: false,
    drawPolyline: false,
    drawText: false,
    cutPolygon: false,
    editMode: false,
    dragMode: false,
    rotateMode: false,
  })

  mymap.pm.setGlobalOptions({ snappable: false })

  mymap.on('pm:create', function (event) {
    let geo = event.layer.toGeoJSON()
    if (event.shape === 'Circle') {
      let radius = event.layer.getRadius() / 1000 // m -> km
      geo = turf.circle(geo, radius)
    }
    let zones = []
    for (let feature of zoneData.features) {
      if (turf.booleanIntersects(geo, feature)) {
        zones.push(feature.properties["SEED_ZONES"])
      }
    }
    event.layer.bindTooltip(`Zones:\n${zones.join('\n')}`)
  })

  const onZones = (event) => {
    console.log('EV', event.target.checked)
    if (event.target.checked) {
      markerLayerGroup.addTo(mymap)
    } else {
      mymap.removeLayer(markerLayerGroup)
    }
  }

  let openStreetMap = L.tileLayer.provider('OpenStreetMap', {})
  let openTopoMap = L.tileLayer.provider('OpenTopoMap', {})

  // Add map baselayers to controls
  control.addBaseLayer(openStreetMap, 'Standard')
  control.addBaseLayer(openTopoMap, 'Topographical')

  // Enable as default
  openStreetMap.addTo(mymap)
  mymap.addControl(control)

  // Add data controls
  L.Control.Box = L.Control.extend({
    options: { position: 'bottomleft' },
    onAdd: function () {
      let div = L.DomUtil.create('div', 'control-box')
      div.innerHTML = `
        <label for="zones">Show Zone Numbers</label>
        <input type="checkbox" id="zones" onchange="onZones(event)" checked>`
      return div
    },
  })

  let ctlBox = new L.Control.Box
  mymap.addControl(ctlBox)

  // Create a layer for zone markers
  let markerLayerGroup = L.layerGroup()
  markerLayerGroup.addTo(mymap)

  // Get the zones geoJSON
  let zoneData
  let zoneLayer
  fetch("Forest_Reproductive_Materials_Regions_Of_Provenance_GB.geojson")
    .then((response) => response.json())
    .then((data) => {
      // Preserve original geoJSON
      zoneData = data
      zoneLayer = L.geoJSON(data, {
        style: function (feature) {
          return {
            fillColor: 'blue',
            fillOpacity: 0.1,
            weight: 2,
          }
        },
        onEachFeature: function (feature, layer) {
          if (feature.properties && feature.properties["SEED_ZONES"]) {
            // Add zone as popup to each layer
            layer.bindPopup(`${feature.properties["SEED_ZONES"]}`, { autoClose: false, closeButton: true })
            let centre = turf.centroid(feature)
            let centreCoords = centre.geometry.coordinates.reverse()
            let marker = L.marker(centreCoords, {
              icon: L.divIcon({
                className: "zone-label",
                html: feature.properties["SEED_ZONES"],
                // Hide the icon
                opacity: 0,
              })
            })
            markerLayerGroup.addLayer(marker)
          }
        }
      }).addTo(mymap)
    })
</script>

</body>
</html>

